(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{600:function(t,e,o){"use strict";o.r(e);var a=o(42),s=Object(a.a)({},(function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[o("h1",{attrs:{id:"challenge-6-vm-custom-script-extensions-post-deployment-automation"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#challenge-6-vm-custom-script-extensions-post-deployment-automation"}},[t._v("#")]),t._v(" Challenge 6: VM - Custom Script Extensions: Post deployment automation")]),t._v(" "),o("h2",{attrs:{id:"or-configure-setup-install-something-within-an-empty-vm"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#or-configure-setup-install-something-within-an-empty-vm"}},[t._v("#")]),t._v(" or - configure / setup / install something within an empty vm")]),t._v(" "),o("p",[o("RouterLink",{attrs:{to:"/day1/"}},[t._v("back")])],1),t._v(" "),o("h2",{attrs:{id:"here-is-what-you-will-learn"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#here-is-what-you-will-learn"}},[t._v("#")]),t._v(" Here is what you will learn")]),t._v(" "),o("ul",[o("li",[t._v("How to automate the further configuration / setup of an '"),o("em",[t._v("empty")]),t._v("' VM after it has been deployed.")]),t._v(" "),o("li",[t._v("Use a Custom Script Extension for a Windows VM.")]),t._v(" "),o("li",[t._v("Upload automation code into a storage account for anonymous download (so that the CSE agent can download)")]),t._v(" "),o("li",[t._v("Modify an ARM Template to enable '"),o("em",[t._v("0 touch VM deployments")]),t._v("'")])]),t._v(" "),o("h2",{attrs:{id:"attach-a-simple-helloworld-custom-script-extension-cse-to-a-vm-using-the-portal"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#attach-a-simple-helloworld-custom-script-extension-cse-to-a-vm-using-the-portal"}},[t._v("#")]),t._v(" Attach a simple HelloWorld Custom Script Extension (CSE) to a VM using the Portal")]),t._v(" "),o("ol",[o("li",[t._v("Take the following code and copy & paste it into a file named e.g. '"),o("em",[t._v("HelloWorld.ps1")]),t._v("':")])]),t._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[t._v('##############################################\n#   HelloWorld Custom Script Extension (CSE)\n##############################################\n\n$filePath = "c:\\temp\\CSEwasRunAt.txt"\n\n#create dir if it doesn\'t exist\nif (!(Test-Path -Path (Split-Path $filePath -Parent))) {mkdir (Split-Path $filePath -Parent)}\n\n#write current time to file.\nGet-Date | Out-File $filePath -Append\n\n#This is really simple but imagine what else you can do to customize a vm ...\n\n')])])]),o("ol",{attrs:{start:"2"}},[o("li",[t._v("Make this file being executed by the Custom Script Extension within the the VM:")])]),t._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[t._v("[Azure Portal] -> Resource Groups -> 'rg-contosomortgage-www' -> 'vmweb01'\n  -> Extensions -> Add -> 'Custom Script Extension' -> Create\n")])])]),o("table",[o("thead",[o("tr",[o("th",[t._v("Script file (Required)")]),t._v(" "),o("th",[t._v("Browse to your '"),o("em",[t._v("HelloWorld.ps1")]),t._v("'")])])]),t._v(" "),o("tbody",[o("tr",[o("td",[t._v("Arguments (Optional)")]),t._v(" "),o("td",[o("em",[t._v("none")])])])])]),t._v(" "),o("p",[o("strong",[t._v("Wait until uploaded")]),o("br"),t._v(" "),o("img",{attrs:{src:"AddCSE-HelloWorldToVM.PNG",alt:"alt"}}),o("br"),t._v(" "),o("strong",[o("em",[t._v("then")]),t._v(" press OK")])]),t._v(" "),o("p",[t._v("Do a "),o("strong",[t._v("refresh")]),t._v(" of your browser - it'll show the progress:"),o("br"),t._v(" "),o("img",{attrs:{src:"AddCSE-HelloWorldToVM2.PNG",alt:"Reload the page"}})]),t._v(" "),o("p",[t._v("Final result should show a success:"),o("br"),t._v(" "),o("img",{attrs:{src:"AddCSE-HelloWorldToVM3.PNG",alt:"Result"}})]),t._v(" "),o("h2",{attrs:{id:"see-what-has-happened-inside-the-vm"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#see-what-has-happened-inside-the-vm"}},[t._v("#")]),t._v(" See what has happened inside the VM")]),t._v(" "),o("p",[t._v("Now we "),o("strong",[t._v("RDP into the VM")]),t._v(" and see what has happened "),o("strong",[t._v("and where to find logs")]),t._v(" in case something breaks.")]),t._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[t._v("[Azure Portal] -> Resource Groups -> 'rg-contosomortgage-www' -> 'vmweb01'\n  -> Connect -> Download RDP file -> Open -> Connect\n")])])]),o("p",[o("strong",[t._v("User")]),t._v(": demouser"),o("br"),t._v(" "),o("strong",[t._v("Password")]),t._v(": "),o("em",[t._v("%Your Password%")])]),t._v(" "),o("p",[t._v("Within the VM:")]),t._v(" "),o("ol",[o("li",[o("p",[o("strong",[t._v("Navigate to c:\\temp")]),o("br"),t._v("\nThe "),o("strong",[t._v("result")]),t._v(" should look similar to this:"),o("br"),t._v(" "),o("img",{attrs:{src:"AddCSE-HelloWorldToVM4Result.PNG",alt:"CSE Result"}})])]),t._v(" "),o("li",[o("p",[o("strong",[t._v("Navigate to C:\\Packages\\Plugins\\Microsoft.Compute.CustomScriptExtension\\ "),o("em",[t._v("%version%")]),t._v("\\Downloads")]),t._v("\nThe CSE is software that runs within the VM. The script that will be executed is "),o("strong",[t._v("download")]),t._v("ed first to this "),o("strong",[t._v("location")]),t._v(". If you don't see your script file CSE might have trouble to download the resource."),o("br"),t._v(" "),o("img",{attrs:{src:"AddCSE-HelloWorldToVM5DownloadFolder.PNG",alt:"CSE Download Folder"}})])]),t._v(" "),o("li",[o("p",[o("strong",[t._v("Navigate to C:\\WindowsAzure\\Logs\\Plugins\\Microsoft.Compute.CustomScriptExtension\\ "),o("em",[t._v("%version%")])]),t._v("\nThis is the place where the "),o("strong",[t._v("CSE logs its actions locally")]),t._v(" - a good place to start troubleshooting."),o("br"),t._v(" "),o("img",{attrs:{src:"AddCSE-HelloWorldToVM6LogsFolder.PNG",alt:"CSE Logs Folder"}})])])]),t._v(" "),o("h2",{attrs:{id:"optional-attaching-a-cse-to-a-vm-in-an-arm-template"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#optional-attaching-a-cse-to-a-vm-in-an-arm-template"}},[t._v("#")]),t._v(" [optional] Attaching a CSE to a VM in an ARM Template")]),t._v(" "),o("p",[t._v("The goal of this action is to learn how to avoid the portal, i.e. so that the CSE can be attached to a VM during deployment time e.g. using an ARM template. With the whole setup Azure + VM Settings can be done in a '"),o("em",[t._v("0 touch way")]),t._v("'.")]),t._v(" "),o("ol",[o("li",[t._v("In order to "),o("strong",[t._v("run the next CSE")]),t._v(" - you "),o("strong",[t._v("need to unload the previous one")])])]),t._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[t._v("[Azure Portal] -> Resource Groups -> 'rg-contosomortgage-www' -> 'vmweb01'\n  -> Extensions -> CustomScriptExtension -> 'Uninstall'\n")])])]),o("p",[t._v("(Note: See what happens to your C:\\Packages folder in the VM)")]),t._v(" "),o("ol",{attrs:{start:"2"}},[o("li",[o("p",[t._v("In the next CSE "),o("strong",[t._v("we want to install Internet Information Services (IIS) in the VM")]),t._v("."),o("br"),t._v('\nTake a look at the code file first ("'),o("a",{attrs:{href:"CSE_Install-IIS.ps1"}},[t._v("CSE_Install-IIS.ps1")]),t._v('")'),o("br"),t._v("\nThe relevant parts starts at "),o("em",[t._v("#region install IIS features")])])]),t._v(" "),o("li",[o("p",[t._v("When automating CSE e.g. through "),o("strong",[t._v("ARM deployment")]),t._v(" - the CSE "),o("strong",[t._v("needs a valid download location for the code file")]),t._v(" (CSE_Install-IIS.ps1)."),o("br"),t._v("\nThis could be e.g. a public github repo or another https-reachable location."),o("br"),t._v("\nIn this lab "),o("strong",[t._v("we use a storage account for this")]),t._v(".\nIf you don't have a storage account yet (from a previous lab). Let's create one:")])])]),t._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[t._v("[Azure Portal] -> Resource Groups -> 'rg-contosomortgage-www' -> '+' -> Storage Account \n")])])]),o("table",[o("thead",[o("tr",[o("th",[t._v("Parameter Name")]),t._v(" "),o("th",[t._v("Value")])])]),t._v(" "),o("tbody",[o("tr",[o("td",[t._v("Resource Group")]),t._v(" "),o("td",[o("strong",[t._v("rg-contosomortgage-www")])])]),t._v(" "),o("tr",[o("td",[t._v("Storage account name")]),t._v(" "),o("td",[o("strong",[o("em",[t._v("cse%SomeUniqueLowerCaseValue%")])])])]),t._v(" "),o("tr",[o("td",[t._v("Location")]),t._v(" "),o("td",[o("strong",[t._v("(Europe) North Europe")])])]),t._v(" "),o("tr",[o("td",[t._v("Performance")]),t._v(" "),o("td",[t._v("Standard")])]),t._v(" "),o("tr",[o("td",[t._v("Account kind")]),t._v(" "),o("td",[t._v("StorageV2")])]),t._v(" "),o("tr",[o("td",[t._v("Replication")]),t._v(" "),o("td",[o("strong",[t._v("Locally-redundant storage (LRS)")])])]),t._v(" "),o("tr",[o("td",[t._v("Access tier")]),t._v(" "),o("td",[t._v("Hot")])])])]),t._v(" "),o("p",[t._v("Once the storage account has been created - navigate to it "),o("strong",[t._v("and create a container")]),t._v(":")]),t._v(" "),o("table",[o("thead",[o("tr",[o("th",[t._v("Parameter Name")]),t._v(" "),o("th",[t._v("Value")])])]),t._v(" "),o("tbody",[o("tr",[o("td",[t._v("Container Name")]),t._v(" "),o("td",[o("strong",[t._v("cse")])])]),t._v(" "),o("tr",[o("td",[t._v("Public access level")]),t._v(" "),o("td",[o("strong",[t._v("Blob")])])])])]),t._v(" "),o("p",[t._v("And "),o("strong",[t._v("upload the CSE_Install-IIS.ps1 script into the container")]),t._v(":")]),t._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[t._v("[Azure Portal] -> Resource Groups -> 'rg-contosomortgage-www' -> %Your Storage Account% -> Container -> 'cse' -> Upload\n")])])]),o("p",[o("img",{attrs:{src:"saUploadCSE1.PNG",alt:"Upload the CSE_Install-IIS.ps1 to storage account"}})]),t._v(" "),o("ol",{attrs:{start:"4"}},[o("li",[o("strong",[t._v("Edit the CSE ARM template to use the correct scripts location")]),t._v("\nOnce uploaded you can copy the blobs URL from the azure portal"),o("br"),t._v(" "),o("img",{attrs:{src:"saUploadCSE2.PNG",alt:"Copy the URL of the IIS install script"}})])]),t._v(" "),o("p",[o("strong",[t._v("Can you download the file in your browser using the URL")]),t._v("? [Yes] If not have you set the correct access level at the container?")]),t._v(" "),o("p",[o("strong",[t._v("Edit this")]),t._v(" "),o("a",{attrs:{href:"ARMCSE.json"}},[t._v("CSE ARM template")]),t._v(" "),o("strong",[t._v("template")]),t._v(" to use the scripts location:\n"),o("img",{attrs:{src:"ModifyARM.PNG",alt:"Edit following ARM section"}})]),t._v(" "),o("p",[o("strong",[t._v("with your value")])]),t._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[t._v('...\n"fileUris": [\n    "https://cse.....blob.core.windows.net/cse/CSE_Install-IIS.ps1"\n],\n...\n')])])]),o("p",[o("strong",[t._v("Copy the template into the clipboard.")])]),t._v(" "),o("ol",{attrs:{start:"5"}},[o("li",[t._v("Deploy the ARM Template.")])]),t._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[t._v("[Azure Portal] -> Resource Groups -> 'rg-contosomortgage-www' -> '+' -> Template deployment -> \"Build your own template in the editor\" -> Paste the clipboard\n")])])]),o("p",[t._v("Select the right resource group and VM and deploy:")]),t._v(" "),o("p",[o("img",{attrs:{src:"ModifyARMDeployment.PNG",alt:"CSE deployment via ARM"}})]),t._v(" "),o("p",[t._v("Deployment will take some minutes: A role is installed and an IIS feature is downloaded and installed."),o("br"),t._v("\nAt the end "),o("strong",[t._v("the result should look like this")]),o("br"),t._v(" "),o("img",{attrs:{src:"ModifyARMSuccessfulDeployment.PNG",alt:"CSE via ARM successful deployment"}}),o("br"),t._v("\nNow you have a web server in your VM.")]),t._v(" "),o("p",[o("RouterLink",{attrs:{to:"/day1/"}},[t._v("back")])],1)])}),[],!1,null,null,null);e.default=s.exports}}]);